const peluches = [

  
];

const personajes = [ 

  ];

const variedades = [
  {
    id: "srb-135-lata-carino-17",
    nombre: "SRB| 13.5 Simpson Roll Lata CON CARIÑO 17 cm",
    precio: 22500,
    imagen: "imagenes/variedades/srb-135-lata-carino-17.jpg",
    descripcionCorta: "Simpson Roll presentado en lata con el mensaje 'CON CARIÑO'. Tamaño: 17 cm. Ideal para regalar y sorprender.",
    categoria: "variedades"
  },
  {
    id: "srb-135-lata-felizdia-17",
    nombre: "SRB| 13.5 Simpson Roll Lata FELIZ DIA 17 cm",
    precio: 22500,
    imagen: "imagenes/variedades/srb-135-lata-felizdia-17.jpg",
    descripcionCorta: "Simpson Roll en lata con el mensaje 'FELIZ DIA'. Tamaño de 17 cm. Un detalle especial para ocasiones felices.",
    categoria: "variedades"
  },
  {
    id: "srb-135-botella-parati-24",
    nombre: "SRB| 13.5 Simpson Roll Botella PARA TI 24 cm",
    precio: 22500,
    imagen: "imagenes/variedades/srb-135-botella-parati-24.jpg",
    descripcionCorta: "Simpson Roll en botella con el mensaje 'PARA TI'. Tamaño: 24 cm. Perfecto para regalos personalizados.",
    categoria: "variedades"
  },
  {
    id: "srb-135-lata-felicidades-17",
    nombre: "SRB| 13.5 Simpson Roll Lata FELICIDADES EN TU DIA 17 cm",
    precio: 22500,
    imagen: "imagenes/variedades/srb-135-lata-felicidadesentu-17.jpg",
    descripcionCorta: "Simpson Roll en lata con el mensaje 'FELICIDADES EN TU DIA'. Tamaño: 17 cm. Un regalo ideal para celebrar.",
    categoria: "variedades"
  },
  {
    id: "srb-135-lata-parati-felizdia-17",
    nombre: "SRB| 13.5 Simpson Roll Lata PARA TI FELIZ DIA 17 cm",
    precio: 22500,
    imagen: "imagenes/variedades/srb-135-lata-paratifelizdia-17.jpg",
    descripcionCorta: "Simpson Roll en lata con mensaje 'PARA TI FELIZ DIA'. Tamaño: 17 cm. Un detalle único.",
    categoria: "variedades"
  },
  {
    id: "srb-135-botella-felicidades-24",
    nombre: "SRB| 13.5 Simpson Roll Botella FELICIDADES 24 cm",
    precio: 22500,
    imagen: "imagenes/variedades/srb-135-botella-felicidades-24.jpg",
    descripcionCorta: "Simpson Roll en botella con el mensaje 'FELICIDADES'. Tamaño: 24 cm. Perfecto para celebraciones.",
    categoria: "variedades"
  },
  {
    id: "srb-135-botella-milfelicidades-24",
    nombre: "SRB| 13.5 Simpson Roll Botella MIL FELICIDADES 24 cm",
    precio: 22500,
    imagen: "imagenes/variedades/srb-135-botella-milfelicidades-24.jpg",
    descripcionCorta: "Simpson Roll en botella con el mensaje 'MIL FELICIDADES'. Tamaño: 24 cm. Regalo ideal para felicitar.",
    categoria: "variedades"
  },
  {
    id: "srb-135-botella-entudia-24",
    nombre: "SRB| 13.5 Simpson Roll Botella EN TU DIA 24 cm",
    precio: 22500,
    imagen: "imagenes/variedades/srb-135-botella-entudia-24.jpg",
    descripcionCorta: "Simpson Roll en botella con el mensaje 'EN TU DIA'. Tamaño: 24 cm. Perfecto para cualquier celebración.",
    categoria: "variedades"
  },
  {
    id: "bsb-89-beer-homero-29",
    nombre: "BSB|8.9 Cerveza beer simpsons HOMERO FELIZ DIA 7.5x7x29 cms",
    precio: 15000,
    imagen: "imagenes/variedades/bsb-89-beer-homero-29.jpg",
    descripcionCorta: "Cerveza de peluche estilo Simpsons, personaje Homero con mensaje 'FELIZ DIA'. Tamaño: 7.5x7x29 cm.",
    categoria: "variedades"
  },
  {
    id: "bsb-89-beer-duffman-29",
    nombre: "BSB|8.9 Cerveza beer simpsons DUFFMAN ESPECIAMENTE PARA TI 7.5x7x29 cms",
    precio: 15000,
    imagen: "imagenes/variedades/bsb-89-beer-duffman-29.jpg",
    descripcionCorta: "Cerveza de peluche estilo Simpsons, personaje DuffMan con mensaje 'ESPECIAMENTE PARA TI'. Tamaño: 7.5x7x29 cm.",
    categoria: "variedades"
  },
  {
    id: "bsb-88-beer-bart-29",
    nombre: "BSB|8.8 Cerveza beer simpsons BART: FELIZ CUMPLE 7.5x7x29 cms",
    precio: 14500,
    imagen: "imagenes/variedades/bsb-88-beer-bart-29.jpg",
    descripcionCorta: "Cerveza de peluche estilo Simpsons, personaje Bart con mensaje 'FELIZ CUMPLE'. Tamaño: 7.5x7x29 cm.",
    categoria: "variedades"
  },
  {
    id: "bsb-88-beer-nelson-29",
    nombre: "BSB|8.8 Cerveza beer simpsons NELSON: CON CARIÑO PARA TI 7.5x7x29 cms",
    precio: 14500,
    imagen: "imagenes/variedades/bsb-88-beer-nelson-29.jpg",
    descripcionCorta: "Cerveza de peluche estilo Simpsons, personaje Nelson con mensaje 'CON CARIÑO PARA TI'. Tamaño: 7.5x7x29 cm.",
    categoria: "variedades"
  },
  {
    id: "5161-32-splash-vct-60ml",
    nombre: "5161| 3.2 Splash 60ml Vct",
    precio: 5500,
    imagen: "imagenes/5161-1536x1536.jpeg",
    descripcionCorta: "Splash Vct de 60ml, ideal para refrescarte en cualquier momento. Presentación pequeña y práctica.",
    categoria: "variedades"
  },
  {
    id: "1278-87-splash-vct-250ml-dorada",
    nombre: "1278|8.7 Splash Vct tapa dorada 250ml SURTIDO",
    precio: 14500,
    imagen: "imagenes/tapa-dorada-.jpg",
    descripcionCorta: "Splash Vct de 250ml con tapa dorada. Fragancias surtidas para todos los gustos.",
    categoria: "variedades"
  },
  {
    id: "1819-47-splash-vct-125ml",
    nombre: "1819|4.7 Splash Vct 125ml SURTIDO",
    precio: 7500,
    imagen: "imagenes/splash-250.jpg",
    descripcionCorta: "Splash Vct de 125ml, fragancias surtidas. Una excelente opción para el día a día.",
    categoria: "variedades"
  },
  {
    id: "1317-79-splash-pk-250ml",
    nombre: "1317|7.9 Splash Pk 250ml SURTIDO",
    precio: 13000,
    imagen: "imagenes/pink-250.jpg",
    descripcionCorta: "Splash Pk de 250ml, fragancias surtidas. Disfruta de aromas frescos y duraderos.",
    categoria: "variedades"
  },
  {
    id: "1186-47-splash-mini-pk-75ml",
    nombre: "1186|4.7 Splash mini Pk 75ml SURTIDO",
    precio: 7500,
    imagen: "imagenes/mini-pink-75.jpg",
    descripcionCorta: "Splash mini Pk de 75ml, fragancias surtidas. Práctico para llevar en el bolso o mochila.",
    categoria: "variedades"
  }
];

// ---- Renderizado por sección ----
function renderProductos(lista, gridId) {
    const grid = document.getElementById(gridId);
    grid.innerHTML = "";
    // Filtra productos válidos: deben tener nombre, imagen y precio
    const productosValidos = lista.filter(
        p => p && p.nombre && p.imagen && typeof p.precio !== "undefined"
    );
    if (!productosValidos.length) {
        grid.innerHTML = "<p>No se encontraron productos.</p>";
        return;
    }
    productosValidos.forEach(producto => {
        grid.innerHTML += `
        <div class="producto-card">
            <img src="${producto.imagen}" alt="${producto.nombre}">
            <h3>${producto.nombre}</h3>
            <p class="precio">$${producto.precio.toLocaleString('es-CO')}</p>
            <a href="detalle-producto.html?id=${producto.id}" class="btn-secondary">Ver Detalles</a>
            <button class="btn-cart"
                data-id="${producto.id}"
                data-nombre="${producto.nombre}"
                data-precio="${producto.precio}"
                data-imagen="${producto.imagen}"
                title="Añadir al carrito">
                <img src="assets/icons/cart.svg" alt="Añadir al carrito">
            </button>
        </div>
        `;
    });
  const seccion = grid.closest('.seccion-productos');
    if (seccion) {
        seccion.style.display = productosValidos.length > 0 ? "" : "none";
    }
}

// ---- Carrito ----
document.addEventListener("click", function(e) {
    const btn = e.target.closest(".btn-cart");
    if (btn) {
        const id = btn.getAttribute("data-id");
        const nombre = btn.getAttribute("data-nombre");
        const precio = parseInt(btn.getAttribute("data-precio"));
        const imagen = btn.getAttribute("data-imagen");
        let carrito = JSON.parse(localStorage.getItem("carrito")) || [];
        const item = carrito.find(p => p.id === id);
        if (item) {
            item.cantidad += 1;
        } else {
            carrito.push({ id, nombre, precio, imagen, cantidad: 1 });
        }
        localStorage.setItem("carrito", JSON.stringify(carrito));
        // Actualiza el contador visual (total unidades en el carrito)
        const cartCount = document.querySelector('.cart-count');
        if (cartCount) {
            let totalUnidades = carrito.reduce((sum, prod) => sum + prod.cantidad, 0);
            cartCount.textContent = totalUnidades;
        }
        alert('Producto añadido al carrito');
    }
});

// ---- Buscador Global ----
const inputBusqueda = document.getElementById('busqueda-productos');
const formBusqueda = document.querySelector('.search-form');

// Si no existe alguna sección, que sea array vacío
const personajesArray = typeof personajes !== "undefined" ? personajes : [];
const peluchesArray = typeof peluches !== "undefined" ? peluches : [];
const variedadesArray = typeof variedades !== "undefined" ? variedades : [];

// --- Filtrar productos ocultos (eliminados desde el panel admin localmente) ---
let productosOcultos = JSON.parse(localStorage.getItem("productosOcultos")) || [];

function filtraOcultos(arr) {
    return arr.filter(p => !productosOcultos.includes(p.id));
}

// Función para renderizar y filtrar según la categoría
function inicializarVista(personajesArr, peluchesArr, variedadesArr) {
    // Actualiza contador carrito al cargar
    const carrito = JSON.parse(localStorage.getItem("carrito")) || [];
    const cartCount = document.querySelector('.cart-count');
    if (cartCount) {
        let totalUnidades = carrito.reduce((sum, prod) => sum + prod.cantidad, 0);
        cartCount.textContent = totalUnidades;
    }

    // Mostrar por categoría
    const cat = getCategoriaURL();

    if (cat === "personajes") {
        renderProductos(personajesArr, "grid-personajes");
        document.getElementById("seccion-personajes").style.display = "";
        document.getElementById("seccion-peluches").style.display = "none";
        document.getElementById("seccion-variedades").style.display = "none";
        document.getElementById("seccion-personajes").scrollIntoView({behavior: "smooth"});
    } else if (cat === "peluches") {
        renderProductos(peluchesArr, "grid-peluches");
        document.getElementById("seccion-personajes").style.display = "none";
        document.getElementById("seccion-peluches").style.display = "";
        document.getElementById("seccion-variedades").style.display = "none";
        document.getElementById("seccion-peluches").scrollIntoView({behavior: "smooth"});
    } else if (cat === "variedades") {
        renderProductos(variedadesArr, "grid-variedades");
        document.getElementById("seccion-personajes").style.display = "none";
        document.getElementById("seccion-peluches").style.display = "none";
        document.getElementById("seccion-variedades").style.display = "";
        document.getElementById("seccion-variedades").scrollIntoView({behavior: "smooth"});
    } else {
        document.getElementById("seccion-personajes").style.display = "";
        document.getElementById("seccion-peluches").style.display = "";
        document.getElementById("seccion-variedades").style.display = "";
        renderProductos(personajesArr, "grid-personajes");
        renderProductos(peluchesArr, "grid-peluches");
        renderProductos(variedadesArr, "grid-variedades");
    }
}

// ---- Buscador adaptado ----
function filtrarProductos(texto, personajesArr, peluchesArr, variedadesArr) {
    texto = texto.trim().toLowerCase();
    const productosTotales = [
        ...personajesArr,
        ...peluchesArr,
        ...variedadesArr
    ].filter(producto => producto && producto.nombre); // Evita productos vacíos

    const filtrados = productosTotales.filter(producto =>
        producto.nombre.toLowerCase().includes(texto) ||
        (producto.descripcionCorta && producto.descripcionCorta.toLowerCase().includes(texto)) ||
        (producto.descripcion && producto.descripcion.toLowerCase().includes(texto))
    );

    renderProductos(
        filtrados.filter(p => p.__seccion === "personajes"),
        "grid-personajes"
    );
    renderProductos(
        filtrados.filter(p => p.__seccion === "peluches"),
        "grid-peluches"
    );
    renderProductos(
        filtrados.filter(p => p.__seccion === "variedades"),
        "grid-variedades"
    );
}
// ---- Inicializar: MOSTRAR CATEGORÍA O TODO ----
function getCategoriaURL() {
  const params = new URLSearchParams(window.location.search);
  return params.get('cat');
}

// ---- CARGAR PRODUCTOS DE FIRESTORE + FIJOS ----
document.addEventListener("DOMContentLoaded", function() {
    // Copias de los arrays para combinar fijos y Firestore
   let personajesArrayFull = filtraOcultos(personajesArray.slice()).map(p => ({...p, __seccion: "personajes"}));
    let peluchesArrayFull = filtraOcultos(peluchesArray.slice()).map(p => ({...p, __seccion: "peluches"}));
    let variedadesArrayFull = filtraOcultos(variedadesArray.slice()).map(p => ({...p, __seccion: "variedades"}));
    // 1. Carga productos Firestore y agrégalos según categoría
    if (typeof db !== "undefined") {
        db.collection("productos").get().then((querySnapshot) => {
            querySnapshot.forEach((doc) => {
                const p = doc.data();
                // Usa el campo p.id (slug) si existe, si no, usa doc.id (compatibilidad productos viejos)
                const adaptado = {
                    ...p,
                    __seccion: p.categoria,
                    imagen: p.image,
                    nombre: p.name,
                    descripcion: p.detail || "",
                    precio: p.precio || 0,
                    id: p.id ? p.id : doc.id
                };
                if (p.categoria === "personajes") personajesArrayFull.push(adaptado);
                if (p.categoria === "peluches") peluchesArrayFull.push(adaptado);
                if (p.categoria === "variedades") variedadesArrayFull.push(adaptado);
            });

            // Ahora sí, renderiza con todos los productos (fijos + Firestore)
            inicializarVista(personajesArrayFull, peluchesArrayFull, variedadesArrayFull);

            // Buscador global con todos los productos
            if (formBusqueda && inputBusqueda) {
                formBusqueda.addEventListener('submit', function(e) {
                    e.preventDefault();
                    filtrarProductos(inputBusqueda.value, personajesArrayFull, peluchesArrayFull, variedadesArrayFull);
                });
                inputBusqueda.addEventListener('input', function() {
                    filtrarProductos(this.value, personajesArrayFull, peluchesArrayFull, variedadesArrayFull);
                });
            }
        });
    } else {
        // Si no hay db (por algún error), muestra solo los fijos
        inicializarVista(personajesArrayFull, peluchesArrayFull, variedadesArrayFull);
        if (formBusqueda && inputBusqueda) {
            formBusqueda.addEventListener('submit', function(e) {
                e.preventDefault();
                filtrarProductos(inputBusqueda.value, personajesArrayFull, peluchesArrayFull, variedadesArrayFull);
            });
            inputBusqueda.addEventListener('input', function() {
                filtrarProductos(this.value, personajesArrayFull, peluchesArrayFull, variedadesArrayFull);
            });
        }
    }
});
